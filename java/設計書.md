# Javaメソッド抽出ツール 設計書

## 1. 概要設計

### 1.1 目的
Javaファイルからメソッドの名称、引数、戻り値の型、修飾子、ファイル名、行番号を抽出し、CSV形式またはコンソールに出力するツール。単一ファイルまたは一覧CSVファイルに記載された複数ファイルを一括処理可能。

### 1.2 機能概要
- **単一ファイルモード**: 指定されたJavaファイルを読み込み、メソッド定義を抽出
- **一覧CSVモード**: 一覧CSVファイルに記載された複数のJavaファイルを一括処理
- 複数のメソッド定義パターンに対応
- 抽出したメソッド情報をCSV形式またはコンソールに出力

### 1.3 システム構成

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │
       │ コマンド実行
       ▼
┌─────────────────────────────┐
│      main()                  │
│  - 引数チェック              │
│  - オプション解析            │
└──────┬──────────────────────┘
       │
       │ JavaMethodExtractor作成
       ▼
┌─────────────────────────────┐
│ JavaMethodExtractor          │
│  - read_file()              │
│  - extract_methods()         │
│  - print_results()          │
│  - export_to_csv()          │
└──────┬──────────────────────┘
       │
       │ ファイル読み込み
       ▼
┌─────────────────────────────┐
│      ファイルシステム        │
└─────────────────────────────┘
```

### 1.4 処理フロー

#### 1.4.1 単一ファイルモード

1. **初期化**
   - コマンドライン引数を解析
   - `JavaMethodExtractor`インスタンスを作成

2. **ファイル読み込み**
   - 指定されたJavaファイルを読み込み
   - ファイル内容をメモリに保持

3. **メソッド抽出**
   - 正規表現パターンを使用してメソッド定義を検索
   - 各パターンにマッチするメソッドを抽出
   - メソッド名、引数、戻り値の型、修飾子、行番号を取得
   - 重複を除去

4. **出力**
   - `--csv`オプション: CSVファイルに出力
   - `--json`オプション: JSON形式でコンソール出力
   - デフォルト: 整形してコンソール出力

#### 1.4.2 一覧CSVモード

1. **一覧CSV読み込み**
   - 一覧CSVファイルを読み込み
   - 1列目からファイルパスのリストを取得（絶対パス対応）
   - ヘッダー行を自動検出してスキップ

2. **各ファイルの処理**
   - 各ファイルに対して以下を実行:
     - ファイルの存在確認
     - `JavaMethodExtractor`インスタンスを作成
     - メソッド抽出を実行
     - エラーが発生した場合は警告を表示して次のファイルへ

3. **結果の統合**
   - 全ファイルから抽出したメソッド情報を統合
   - 1つのCSVファイルに出力

### 1.5 入力・出力

#### 入力
- **単一ファイルモード**: Javaファイルのパス（必須）
  - オプション: `--csv [出力ファイル名]` または `--json`
- **一覧CSVモード**: 一覧CSVファイルのパス（必須）
  - オプション: 出力ファイル名（省略時は一覧CSVファイル名_result.csv）

#### 一覧CSVファイルの形式
- 1列目にファイルの絶対パスを記載
- ヘッダー行は任意（あってもなくても可）
- 1行に1つのファイルパス

**例**:
```csv
ファイルパス
C:\path\to\file1.java
C:\path\to\file2.java
C:\path\to\file3.java
```

#### 出力
- CSV形式: ファイル、行番号、クラス、型、修飾子、戻り値の型、メソッド名、引数の列を持つCSVファイル
- JSON形式: メソッド情報のJSON配列（単一ファイルモードのみ）
- コンソール: 整形されたメソッド情報のリスト（単一ファイルモードのみ）

### 1.6 エラーハンドリング

- ファイルが見つからない場合: エラーメッセージを表示して終了（単一ファイルモード）または警告を表示して続行（一覧CSVモード）
- ファイル読み込みエラー: エラーメッセージを表示して終了（単一ファイルモード）または警告を表示して続行（一覧CSVモード）
- CSV出力エラー: エラーメッセージを表示して終了

---

## 2. パターン一覧設計

### 2.1 対応するメソッド定義パターン

本ツールは以下のJavaメソッド定義パターンを検出します。

#### 2.1.1 通常のメソッド定義（Method Definition）

**パターン**: `[修飾子] 戻り値の型 メソッド名(引数) { ... }`

**正規表現**: `r'(?:(?:public|private|protected|static|final|abstract|synchronized|native|strictfp)\s+)*(void|[\w<>\[\]\s,\.]+?)\s+(\w+)\s*\(([^)]*)\)\s*\{'`

**例**:
```java
public String getName() {
    return name;
}

private void setName(String name) {
    this.name = name;
}

public static int calculateSum(int a, int b) {
    return a + b;
}
```

**検出結果**:
- 型: `method`
- メソッド名: `getName`, `setName`, `calculateSum`
- 戻り値の型: `String`, `void`, `int`
- 修飾子: `public`, `private`, `public, static`
- 引数: `[]`, `['String name']`, `['int a', 'int b']`

---

#### 2.1.2 コンストラクタ（Constructor）

**パターン**: `[修飾子] クラス名(引数) { ... }`

**正規表現**: `r'(?:(?:public|private|protected)\s+)?(\w+)\s*\(([^)]*)\)\s*\{'`

**例**:
```java
public class User {
    public User() {
        this.name = "";
    }
    
    public User(String name, int age) {
        this.name = name;
        this.age = age;
    }
}
```

**検出結果**:
- 型: `constructor`
- メソッド名: `User`（クラス名と同じ）
- 戻り値の型: （なし）
- 修飾子: `public`, `public`
- 引数: `[]`, `['String name', 'int age']`

**注意**: クラス名と一致するメソッドのみをコンストラクタとして検出します。

---

#### 2.1.3 インターフェースメソッド（Interface Method）

**パターン**: `default 戻り値の型 メソッド名(引数) { ... }` または `static 戻り値の型 メソッド名(引数) { ... }`

**正規表現**: `r'(?:default|static)\s+(void|[\w<>\[\]\s,\.]+?)\s+(\w+)\s*\(([^)]*)\)\s*\{'`

**例**:
```java
interface Calculator {
    default void printResult(int result) {
        System.out.println("Result: " + result);
    }
    
    static int add(int a, int b) {
        return a + b;
    }
}
```

**検出結果**:
- 型: `interface_method`
- メソッド名: `printResult`, `add`
- 戻り値の型: `void`, `int`
- 修飾子: `default`, `static`
- 引数: `['int result']`, `['int a', 'int b']`

---

### 2.2 戻り値の型の解析

#### 2.2.1 プリミティブ型

**例**: `int`, `long`, `double`, `float`, `boolean`, `char`, `byte`, `short`, `void`

**解析結果**: そのまま保持

---

#### 2.2.2 オブジェクト型

**例**: `String`, `Object`, `List`, `Map`

**解析結果**: そのまま保持

---

#### 2.2.3 配列型

**例**: `int[]`, `String[]`, `int[][]`

**解析結果**: そのまま保持（`int[]`, `String[]`, `int[][]`）

---

#### 2.2.4 ジェネリクス型

**例**: `List<String>`, `Map<String, Integer>`, `List<List<Integer>>`

**解析結果**: そのまま保持（`List<String>`, `Map<String, Integer>`, `List<List<Integer>>`）

---

### 2.3 引数の解析

#### 2.3.1 通常の引数

**例**: `String name`, `int age`, `boolean active`

**解析結果**: `['String name', 'int age', 'boolean active']`

---

#### 2.3.2 可変長引数

**例**: `String... args`, `int... numbers`

**解析結果**: `['String... args']`, `['int... numbers']`

---

#### 2.3.3 ジェネリクス型の引数

**例**: `List<String> items`, `Map<String, Integer> data`

**解析結果**: `['List<String> items']`, `['Map<String, Integer> data']`

---

#### 2.3.4 複雑な型の引数

**例**: `Map<String, List<Integer>> data, String name`

**解析結果**: `['Map<String, List<Integer>> data', 'String name']`

---

### 2.4 修飾子の抽出

以下の修飾子を検出します：

- **アクセス修飾子**: `public`, `private`, `protected`
- **その他の修飾子**: `static`, `final`, `abstract`, `synchronized`, `native`, `strictfp`, `default`

修飾子は複数指定可能で、検出されたすべての修飾子をカンマ区切りで表示します。

---

### 2.5 クラス名の抽出

クラス定義からクラス名を抽出し、各メソッドのコンテキストとして使用します。

**パターン**: `class クラス名 { ... }`

**例**:
```java
public class User {
    // メソッド
}
```

**検出結果**: クラス名 `User` が各メソッドの `class_name` フィールドに設定されます。

---

### 2.6 検出順序

パターンは以下の順序で検出されます（優先度順）：

1. `constructor` - コンストラクタ
2. `interface_method` - インターフェースメソッド
3. `method` - 通常のメソッド

この順序により、より具体的なパターンが先にマッチし、重複を防ぎます。

---

### 2.7 重複除去

同じメソッドが複数のパターンでマッチする場合、以下の優先順位で重複を判定します：

1. `constructor` - 最優先
2. `interface_method` - 次に優先
3. `method` - 最後

優先度の高いパターンが既に存在する場合、優先度の低いパターンは除外されます。

---

## 3. 出力形式

### 3.1 CSV形式

**ヘッダー行**:
```
ファイル,行番号,クラス,型,修飾子,戻り値の型,メソッド名,引数
```

**データ行の例**:
```
TestClass.java,22,TestClass,constructor,private,,TestClass,
TestClass.java,41,TestClass,method,,String,getName,
TestClass.java,48,TestClass,method,public,void,setName,String name
TestClass.java,62,TestClass,method,"public, static",int,calculateSum,"int a, int b"
```

### 3.2 JSON形式

```json
[
  {
    "name": "getName",
    "type": "method",
    "return_type": "String",
    "parameters": [],
    "modifiers": "",
    "class_name": "TestClass",
    "file": "TestClass.java",
    "line": 41
  },
  {
    "name": "setName",
    "type": "method",
    "return_type": "void",
    "parameters": ["String name"],
    "modifiers": "public",
    "class_name": "TestClass",
    "file": "TestClass.java",
    "line": 48
  }
]
```

### 3.3 コンソール出力

```
=== TestClass.java ===

【メソッド 1】
  ファイル: TestClass.java
  クラス: TestClass
  名称: getName
  型: method
  戻り値の型: String
  行番号: 41
  引数: なし

【メソッド 2】
  ファイル: TestClass.java
  クラス: TestClass
  名称: setName
  型: method
  戻り値の型: void
  修飾子: public
  行番号: 48
  引数: String name
```

---

## 4. 使用方法

### 4.1 単一ファイルモード

```bash
# 基本的な使用（コンソール出力）
python search_java.py src/App.java

# CSV形式で出力（デフォルトは元のファイル名.csv）
python search_java.py src/App.java --csv

# CSV形式で出力（ファイル名を指定）
python search_java.py src/App.java --csv output.csv

# JSON形式で出力
python search_java.py src/App.java --json
```

### 4.2 一覧CSVモード

```bash
# 一覧CSVファイルを指定（出力ファイル名は自動生成）
python search_java.py --list file_list.csv

# 一覧CSVファイルを指定（出力ファイル名を指定）
python search_java.py --list file_list.csv result.csv
```

### 4.3 一覧CSVファイルの作成例

`file_list.csv`:
```csv
ファイルパス
C:\Users\user\project\src\App.java
C:\Users\user\project\src\utils\Helper.java
C:\Users\user\project\src\models\User.java
```

または、ヘッダー行なしでも可:
```csv
C:\Users\user\project\src\App.java
C:\Users\user\project\src\utils\Helper.java
C:\Users\user\project\src\models\User.java
```

---

## 5. 制限事項

1. **コメントの抽出**: コメント抽出機能は実装されていません
2. **アノテーション**: メソッドのアノテーションは取得されません
3. **ネストされたクラス**: ネストされたクラス内のメソッドも検出されますが、親クラスとの関係は取得されません
4. **ラムダ式**: ラムダ式は検出されません
5. **メソッド参照**: メソッド参照は検出されません
6. **複雑なジェネリクス**: 非常に複雑なジェネリクス型の場合、完全な解析ができない場合があります
7. **メソッド呼び出しの誤検出**: まれにメソッド呼び出しをメソッド定義として誤検出する場合があります

---

## 6. 今後の拡張案

1. アノテーション情報の取得
2. メソッドのスコープ情報の取得（ネストされたクラス内など）
3. メソッドのJavadocコメントの取得
4. 複数ファイルの一括処理の進捗表示改善
5. フィルタリング機能（メソッド名、型、修飾子などでフィルタ）
6. ラムダ式の検出
7. メソッド参照の検出
8. インターフェースの実装メソッドの検出

---

## 7. 技術的な詳細

### 7.1 正規表現パターン

メソッド定義の検出には正規表現を使用しています。Javaの構文は複雑なため、以下の点に注意が必要です：

- ジェネリクス型の処理（`<`, `>`のネスト）
- 配列型の処理（`[]`の複数）
- 修飾子の順序（任意の順序で出現可能）
- メソッド呼び出しとの区別

### 7.2 誤検出の防止

以下の方法で誤検出を防止しています：

- キーワードの除外（`if`, `for`, `while`など）
- 前後の文字列の確認（メソッド定義の前には修飾子や型がある）
- コンストラクタの場合はクラス名との一致確認
- 重複除去による優先度の高いパターンの保持

### 7.3 パフォーマンス

- ファイル全体をメモリに読み込んで処理
- 正規表現による一括検索
- 大きなファイルでも比較的高速に処理可能

