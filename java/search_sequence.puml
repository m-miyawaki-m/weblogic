@startuml search_sequence.puml
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

actor ユーザー as User
participant "main()" as Main
participant "JavaMethodExtractor" as Extractor
participant "ファイルシステム" as FileSystem
participant "正規表現エンジン" as Regex

User -> Main: コマンド実行
activate Main

Main -> Main: 引数チェック

alt 引数が不足している場合
    Main -> User: 使用方法を表示して終了
    deactivate Main
else 引数が正しい場合
    alt 一覧CSVモードの場合
        Main -> Main: read_file_list(list_csv_path)
        activate Main
        Main -> FileSystem: 一覧CSVファイルを開く
        activate FileSystem
        FileSystem -> Main: CSV内容を返す
        deactivate FileSystem
        Main -> Main: ファイルパスリストを取得
        Main -> Main: process_multiple_files()
        
        loop 各ファイルに対して
            Main -> Extractor: new JavaMethodExtractor(file_path)
            activate Extractor
            note right of Extractor: ファイルパスを保存
            
            Main -> Extractor: extract()
            
            Extractor -> Extractor: read_file()
            Extractor -> FileSystem: ファイルを開く
            activate FileSystem
            FileSystem -> Extractor: ファイル内容を返す
            deactivate FileSystem
            
            alt ファイルが見つからない場合
                Extractor -> Main: 警告を表示して続行
            else ファイル読み込み成功
                Extractor -> Extractor: self.contentに保存
            end
            
            Extractor -> Extractor: extract_methods()
            note right of Extractor: クラス名を抽出
            note right of Extractor: 正規表現パターンを定義
            
            loop 各パターンに対して
                Extractor -> Regex: pattern.finditer(content)
                activate Regex
                Regex -> Extractor: マッチ結果を返す
                deactivate Regex
                
                loop 各マッチ結果に対して
                    alt コンストラクタパターンの場合
                        Extractor -> Extractor: クラス名と一致確認
                        alt クラス名と一致しない場合
                            Extractor -> Extractor: スキップ
                        else クラス名と一致する場合
                            Extractor -> Extractor: メソッド情報を抽出
                        end
                    else インターフェースメソッドパターンの場合
                        Extractor -> Extractor: メソッド情報を抽出
                    else 通常のメソッドパターンの場合
                        Extractor -> Extractor: キーワードチェック
                        alt キーワードの場合
                            Extractor -> Extractor: スキップ
                        else キーワードでない場合
                            Extractor -> Extractor: 前後の文字列を確認
                            alt メソッド定義でない場合
                                Extractor -> Extractor: スキップ
                            else メソッド定義の場合
                                Extractor -> Extractor: メソッド情報を抽出
                            end
                        end
                    end
                    
                    Extractor -> Extractor: 引数を解析
                    Extractor -> Extractor: 戻り値の型から修飾子を除去
                    Extractor -> Extractor: 修飾子を抽出
                    Extractor -> Extractor: 行番号を計算
                    Extractor -> Extractor: メソッド情報をリストに追加
                end
            end
            
            Extractor -> Extractor: 重複を除去
            Extractor -> Main: methodsリストを返す
            deactivate Extractor
        end
        
        Main -> Main: 全ファイルの結果を統合
        Main -> FileSystem: 結果CSVファイルを開く
        activate FileSystem
        Main -> FileSystem: ヘッダー行を書き込み
        loop 各メソッドに対して
            Main -> FileSystem: データ行を書き込み
        end
        FileSystem -> Main: 完了
        deactivate FileSystem
        Main -> User: 結果をCSVファイルに出力しました
    else 単一ファイルモードの場合
        Main -> Extractor: new JavaMethodExtractor(file_path)
        activate Extractor
        note right of Extractor: ファイルパスを保存
        
        Main -> Extractor: extract()
        
        Extractor -> Extractor: read_file()
        Extractor -> FileSystem: ファイルを開く
        activate FileSystem
        FileSystem -> Extractor: ファイル内容を返す
        deactivate FileSystem
        
        alt ファイルが見つからない場合
            Extractor -> User: エラーメッセージを表示
            Extractor -> Main: sys.exit(1)
        else ファイル読み込み成功
            Extractor -> Extractor: self.contentに保存
        end
        
        Extractor -> Extractor: extract_methods()
        note right of Extractor: クラス名を抽出
        note right of Extractor: 正規表現パターンを定義
        
        loop 各パターンに対して
            Extractor -> Regex: pattern.finditer(content)
            activate Regex
            Regex -> Extractor: マッチ結果を返す
            deactivate Regex
            
            loop 各マッチ結果に対して
                alt コンストラクタパターンの場合
                    Extractor -> Extractor: クラス名と一致確認
                    alt クラス名と一致しない場合
                        Extractor -> Extractor: スキップ
                    else クラス名と一致する場合
                        Extractor -> Extractor: メソッド情報を抽出
                    end
                else インターフェースメソッドパターンの場合
                    Extractor -> Extractor: メソッド情報を抽出
                else 通常のメソッドパターンの場合
                    Extractor -> Extractor: キーワードチェック
                    alt キーワードの場合
                        Extractor -> Extractor: スキップ
                    else キーワードでない場合
                        Extractor -> Extractor: 前後の文字列を確認
                        alt メソッド定義でない場合
                            Extractor -> Extractor: スキップ
                        else メソッド定義の場合
                            Extractor -> Extractor: メソッド情報を抽出
                        end
                    end
                end
                
                Extractor -> Extractor: 引数を解析
                Extractor -> Extractor: 戻り値の型から修飾子を除去
                Extractor -> Extractor: 修飾子を抽出
                Extractor -> Extractor: 行番号を計算
                Extractor -> Extractor: メソッド情報をリストに追加
            end
        end
        
        Extractor -> Extractor: 重複を除去
        Extractor -> Main: methodsリストを返す
        
        alt CSVオプションが指定されている場合
            Main -> Extractor: export_to_csv(methods, output_file)
            Extractor -> Extractor: 出力ファイル名を決定
            Extractor -> FileSystem: CSVファイルを開く
            activate FileSystem
            Extractor -> FileSystem: ヘッダー行を書き込み
            loop 各メソッドに対して
                Extractor -> FileSystem: データ行を書き込み
            end
            FileSystem -> Extractor: 完了
            deactivate FileSystem
            Extractor -> User: CSVファイルを出力しました
        else JSONオプションが指定されている場合
            Main -> Main: JSON形式で出力
            Main -> User: JSONデータを表示
        else 通常の表示
            Main -> Extractor: print_results(methods)
            loop 各メソッドに対して
                Extractor -> User: メソッド情報を表示
            end
        end
        
        deactivate Extractor
    end
    
    deactivate Main
end

@enduml

