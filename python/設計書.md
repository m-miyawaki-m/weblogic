# JavaScript関数抽出ツール 設計書

## 1. 概要設計

### 1.1 目的
JavaScriptファイルから関数の名称、引数、ファイル名、行番号を抽出し、CSV形式またはコンソールに出力するツール。単一ファイルまたは一覧CSVファイルに記載された複数ファイルを一括処理可能。

### 1.2 機能概要
- **単一ファイルモード**: 指定されたJavaScriptファイルを読み込み、関数定義を抽出
- **一覧CSVモード**: 一覧CSVファイルに記載された複数のJavaScriptファイルを一括処理
- 複数の関数定義パターンに対応
- 抽出した関数情報をCSV形式またはコンソールに出力

### 1.3 システム構成

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │
       │ コマンド実行
       ▼
┌─────────────────────────────┐
│      main()                  │
│  - 引数チェック              │
│  - オプション解析            │
└──────┬──────────────────────┘
       │
       │ JavaScriptFunctionExtractor作成
       ▼
┌─────────────────────────────┐
│ JavaScriptFunctionExtractor  │
│  - read_file()              │
│  - extract_functions()      │
│  - print_results()          │
│  - export_to_csv()          │
└──────┬──────────────────────┘
       │
       │ ファイル読み込み
       ▼
┌─────────────────────────────┐
│      ファイルシステム        │
└─────────────────────────────┘
```

### 1.4 処理フロー

#### 1.4.1 単一ファイルモード

1. **初期化**
   - コマンドライン引数を解析
   - `JavaScriptFunctionExtractor`インスタンスを作成

2. **ファイル読み込み**
   - 指定されたJavaScriptファイルを読み込み
   - ファイル内容をメモリに保持

3. **関数抽出**
   - 正規表現パターンを使用して関数定義を検索
   - 各パターンにマッチする関数を抽出
   - 関数名、引数、行番号を取得
   - 重複を除去

4. **出力**
   - `--csv`オプション: CSVファイルに出力
   - `--json`オプション: JSON形式でコンソール出力
   - デフォルト: 整形してコンソール出力

#### 1.4.2 一覧CSVモード

1. **一覧CSV読み込み**
   - 一覧CSVファイルを読み込み
   - 1列目からファイルパスのリストを取得
   - 相対パスの場合は絶対パスに変換

2. **各ファイルの処理**
   - 各ファイルに対して以下を実行:
     - ファイルの存在確認
     - `JavaScriptFunctionExtractor`インスタンスを作成
     - 関数抽出を実行
     - エラーが発生した場合は警告を表示して次のファイルへ

3. **結果の統合**
   - 全ファイルから抽出した関数情報を統合
   - 1つのCSVファイルに出力

### 1.5 入力・出力

#### 入力
- **単一ファイルモード**: JavaScriptファイルのパス（必須）
  - オプション: `--csv [出力ファイル名]` または `--json`
- **一覧CSVモード**: 一覧CSVファイルのパス（必須）
  - オプション: 出力ファイル名（省略時は一覧CSVファイル名_result.csv）

#### 一覧CSVファイルの形式
- 1列目にファイルの絶対パスを記載
- ヘッダー行は任意（あってもなくても可）
- 1行に1つのファイルパス

**例**:
```csv
ファイルパス
C:\path\to\file1.js
C:\path\to\file2.js
C:\path\to\file3.js
```

#### 出力
- CSV形式: ファイル、行番号、型、関数名、引数の列を持つCSVファイル
- JSON形式: 関数情報のJSON配列（単一ファイルモードのみ）
- コンソール: 整形された関数情報のリスト（単一ファイルモードのみ）

### 1.6 エラーハンドリング

- ファイルが見つからない場合: エラーメッセージを表示して終了
- ファイル読み込みエラー: エラーメッセージを表示して終了
- CSV出力エラー: エラーメッセージを表示して終了

---

## 2. パターン一覧設計

### 2.1 対応する関数定義パターン

本ツールは以下のJavaScript関数定義パターンを検出します。

#### 2.1.1 関数宣言（Function Declaration）

**パターン**: `function name(...) { ... }`

**正規表現**: `r'function\s+(\w+)\s*\(([^)]*)\)'`

**例**:
```javascript
function greet(name, age) {
    return `Hello, ${name}`;
}
```

**検出結果**:
- 型: `function`
- 関数名: `greet`
- 引数: `['name', 'age']`

---

#### 2.1.2 非同期関数宣言（Async Function Declaration）

**パターン**: `async function name(...) { ... }`

**正規表現**: `r'async\s+function\s+(\w+)\s*\(([^)]*)\)'`

**例**:
```javascript
async function fetchData(url) {
    const response = await fetch(url);
    return response.json();
}
```

**検出結果**:
- 型: `async_function`
- 関数名: `fetchData`
- 引数: `['url']`

---

#### 2.1.3 ジェネレータ関数宣言（Generator Function Declaration）

**パターン**: `function* name(...) { ... }`

**正規表現**: `r'function\s*\*\s*(\w+)\s*\(([^)]*)\)'`

**例**:
```javascript
function* numberRange(start, end) {
    for (let i = start; i <= end; i++) {
        yield i;
    }
}
```

**検出結果**:
- 型: `generator_function`
- 関数名: `numberRange`
- 引数: `['start', 'end']`

---

#### 2.1.4 関数式（Function Expression）

**パターン**: `const/let/var name = function(...) { ... }`

**正規表現**: `r'(?:const|let|var)\s+(\w+)\s*=\s*function\s*\(([^)]*)\)'`

**例**:
```javascript
const multiply = function(a, b) {
    return a * b;
};
```

**検出結果**:
- 型: `function_expression`
- 関数名: `multiply`
- 引数: `['a', 'b']`

---

#### 2.1.5 非同期関数式（Async Function Expression）

**パターン**: `const/let/var name = async function(...) { ... }`

**正規表現**: `r'(?:const|let|var)\s+(\w+)\s*=\s*async\s+function\s*\(([^)]*)\)'`

**例**:
```javascript
const loadData = async function(path) {
    const data = await import(path);
    return data;
};
```

**検出結果**:
- 型: `async_function_expression`
- 関数名: `loadData`
- 引数: `['path']`

---

#### 2.1.6 ジェネレータ関数式（Generator Function Expression）

**パターン**: `const/let/var name = function*(...) { ... }`

**正規表現**: `r'(?:const|let|var)\s+(\w+)\s*=\s*function\s*\*\s*\(([^)]*)\)'`

**例**:
```javascript
const fibonacci = function* (n) {
    let a = 0, b = 1;
    for (let i = 0; i < n; i++) {
        yield a;
        [a, b] = [b, a + b];
    }
};
```

**検出結果**:
- 型: `generator_function_expression`
- 関数名: `fibonacci`
- 引数: `['n']`

---

#### 2.1.7 アロー関数（Arrow Function）

**パターン**: `const/let/var name = (...) => { ... }`

**正規表現**: `r'(?:const|let|var)\s+(\w+)\s*=\s*\(([^)]*)\)\s*=>'`

**例**:
```javascript
const add = (a, b) => {
    return a + b;
};
```

**検出結果**:
- 型: `arrow_function`
- 関数名: `add`
- 引数: `['a', 'b']`

---

#### 2.1.8 非同期アロー関数（Async Arrow Function）

**パターン**: `const/let/var name = async (...) => { ... }`

**正規表現**: `r'(?:const|let|var)\s+(\w+)\s*=\s*async\s+\(([^)]*)\)\s*=>'`

**例**:
```javascript
const fetchUser = async (userId) => {
    const response = await fetch(`/api/users/${userId}`);
    return response.json();
};
```

**検出結果**:
- 型: `async_arrow_function`
- 関数名: `fetchUser`
- 引数: `['userId']`

---

#### 2.1.9 メソッド定義（Method Definition）

**パターン**: `name(...) { ... }` (ES6)

**正規表現**: `r'(\w+)\s*\(([^)]*)\)\s*\{'`

**例**:
```javascript
const calculator = {
    add(a, b) {
        return a + b;
    },
    subtract(x, y) {
        return x - y;
    }
};
```

**検出結果**:
- 型: `method`
- 関数名: `add`, `subtract`
- 引数: `['a', 'b']`, `['x', 'y']`

**注意**: このパターンは誤検出を防ぐため、以下のフィルタリングを行います：
- JavaScriptの予約語・キーワードを除外
- 前後の文字列を確認して、オブジェクトリテラルやクラス内のメソッドかどうかを判定

---

### 2.2 引数の解析

#### 2.2.1 通常の引数

**例**: `function test(a, b, c)`

**解析結果**: `['a', 'b', 'c']`

---

#### 2.2.2 デフォルト引数

**例**: `function createUser(name, age = 18, city = "Tokyo")`

**解析結果**: `['name', 'age', 'city']`

**処理**: デフォルト値の部分（`= 18`など）を除去して変数名のみを抽出

---

#### 2.2.3 分割代入（オブジェクト）

**例**: `function processUser({ name, age, email })`

**解析結果**: `['{ name, age, email }']`

**処理**: 分割代入の場合はそのまま保持

---

#### 2.2.4 分割代入（配列）

**例**: `function getFirstTwo([first, second])`

**解析結果**: `['[first, second]']`

**処理**: 分割代入の場合はそのまま保持

---

#### 2.2.5 レストパラメータ

**例**: `function sum(...numbers)`

**解析結果**: `['...numbers']`

**処理**: レストパラメータもそのまま保持

---

#### 2.2.6 複合パターン

**例**: `function complexFunction(regularParam, { destructured, withDefault = "default" } = {}, ...restParams)`

**解析結果**: `['regularParam', '{ destructured, withDefault', '...restParams']`

**注意**: 複雑な引数パターンでは、完全な解析が難しい場合があります。

---

### 2.3 キーワード除外リスト

メソッドパターンの誤検出を防ぐため、以下のキーワードを除外します：

```python
js_keywords = {
    'if', 'else', 'for', 'while', 'do', 'switch', 'case', 'default',
    'try', 'catch', 'finally', 'throw', 'return', 'break', 'continue',
    'var', 'let', 'const', 'function', 'class', 'extends', 'super',
    'this', 'new', 'typeof', 'instanceof', 'in', 'of', 'with',
    'import', 'export', 'from', 'as', 'default', 'static', 'async',
    'await', 'yield', 'constructor', 'get', 'set', 'delete', 'void'
}
```

---

### 2.4 検出順序

パターンは以下の順序で検出されます（優先度順）：

1. `async_function` - 非同期関数宣言
2. `generator_function` - ジェネレータ関数宣言
3. `function` - 通常の関数宣言
4. `async_function_expression` - 非同期関数式
5. `generator_function_expression` - ジェネレータ関数式
6. `function_expression` - 関数式
7. `async_arrow_function` - 非同期アロー関数
8. `arrow_function` - アロー関数
9. `method` - メソッド定義

この順序により、より具体的なパターンが先にマッチし、重複を防ぎます。

---

### 2.5 重複除去

同じ関数が複数のパターンでマッチする場合、関数名と行番号の組み合わせで重複を判定し、最初にマッチしたもののみを保持します。

---

## 3. 出力形式

### 3.1 CSV形式

**ヘッダー行**:
```
ファイル,行番号,型,関数名,引数
```

**データ行の例**:
```
test.js,13,function,greet,"name, age"
test.js,28,function_expression,multiply,"a, b"
test.js,47,arrow_function,add,"a, b"
```

### 3.2 JSON形式

```json
[
  {
    "name": "greet",
    "type": "function",
    "parameters": ["name", "age"],
    "file": "test.js",
    "line": 13
  },
  {
    "name": "multiply",
    "type": "function_expression",
    "parameters": ["a", "b"],
    "file": "test.js",
    "line": 28
  }
]
```

### 3.3 コンソール出力

```
=== test.js ===

【関数 1】
  ファイル: test.js
  名称: greet
  型: function
  行番号: 13
  引数: name, age

【関数 2】
  ファイル: test.js
  名称: multiply
  型: function_expression
  行番号: 28
  引数: a, b
```

---

## 4. 制限事項

1. **コメントの抽出**: コメント抽出機能は実装されていません
2. **クラスメソッド**: クラス内のメソッドは検出されますが、クラス名は取得されません
3. **ネストされた関数**: ネストされた関数も検出されますが、親関数との関係は取得されません
4. **複雑な引数**: 分割代入やデフォルト引数が複雑に組み合わさった場合、完全な解析ができない場合があります
5. **即時実行関数（IIFE）**: 名前のない即時実行関数は検出されません

---

## 5. 使用方法

### 5.1 単一ファイルモード

```bash
# 基本的な使用（コンソール出力）
python search.py src/app.js

# CSV形式で出力（デフォルトは元のファイル名.csv）
python search.py src/app.js --csv

# CSV形式で出力（ファイル名を指定）
python search.py src/app.js --csv output.csv

# JSON形式で出力
python search.py src/app.js --json
```

### 5.2 一覧CSVモード

```bash
# 一覧CSVファイルを指定（出力ファイル名は自動生成）
python search.py --list file_list.csv

# 一覧CSVファイルを指定（出力ファイル名を指定）
python search.py --list file_list.csv result.csv
```

### 5.3 一覧CSVファイルの作成例

`file_list.csv`:
```csv
ファイルパス
C:\Users\user\project\src\app.js
C:\Users\user\project\src\utils.js
C:\Users\user\project\src\components\Button.js
```

または、ヘッダー行なしでも可:
```csv
C:\Users\user\project\src\app.js
C:\Users\user\project\src\utils.js
C:\Users\user\project\src\components\Button.js
```

---

## 6. 今後の拡張案

1. クラス名の取得
2. 関数のスコープ情報の取得
3. 関数の戻り値の型情報の取得（JSDocコメントから）
5. ディレクトリ再帰的な検索
6. フィルタリング機能（関数名、型などでフィルタ）
7. 進捗表示の改善（一覧CSVモード）

